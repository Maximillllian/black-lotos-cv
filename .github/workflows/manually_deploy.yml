name: Manually deploy
on:
    pull_request:
        types: [opened]
    issue_comment:
        types: [created]

jobs:
    check_need_deploy:
        runs-on: ubuntu-latest
        outputs:
            triggered: ${{ steps.check.outputs.triggered }}
        steps:
            - uses: shanegenschaw/pull-request-comment-trigger@v2.1.0

              id: check
              with:
                  trigger: '/deploy'
                  reaction: rocket
              env:
                  GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
    deploy_manually:
        needs: check_need_deploy
        if: needs.check_need_deploy.outputs.triggered == 'true'

        uses: ./.github/workflows/reusable_deploy.yml
        with:
            host_address: ${{ github.base_ref }}.blacklotos.ru
            image_name: maximillllian/black-lotos-${{ github.base_ref }}:${{ github.sha }}
            # При изменении еще поправить ниже в CONTAINER_NAME
            container_name: black-lotos-${{ github.base_ref }}
        secrets: inherit
    comment:
        needs: deploy_manually
        if: needs.check_need_deploy.outputs.triggered == 'true'

        runs-on: ubuntu-latest
        steps:
            - uses: actions/github-script@v6
              env:
                  HOST_ADDRESS: ${{ github.base_ref }}.blacklotos.ru
              with:
                  script: |
                      const { HOST_ADDRESS } = process.env 
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `Review app successfully deployed [${HOST_ADDRESS}](HOST_ADDRESS)`
                      })
    kill:
        needs: deploy_manually
        if: needs.check_need_deploy.outputs.triggered == 'true'
        runs-on: ubuntu-latest

        steps:
            - name: kill_app
              env:
                  KILL_AFTER: 50
                  PSWD: ${{ secrets.PSWD }}
                  USER: ${{ secrets.USER }}
                  HOST: ${{ secrets.HOST }}
                  CONTAINER_NAME: black-lotos-${{ github.base_ref }}
              run: |
                  sshpass -p ${{ env.PSWD }} ssh -v -o StrictHostKeyChecking=no ${{ env.USER }}@${{ env.HOST }} <<'ENDSSH'
                  sleep ${{ env.KILL_AFTER }}s
                  docker stop ${{ env.CONTAINER_NAME }}
                  docker rm ${{ env.CONTAINER_NAME }}
                  ENDSSH
